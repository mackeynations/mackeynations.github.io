# Slay the Spire and Complexity

*Slay the Spire* is played over 57 floors, each of which offers us a choice. The simplest questions we are posed are binary or trinary, such as [the Shining Light event](https://slay-the-spire.fandom.com/wiki/Shining_Light), in which the player can either do nothing, or exchange 30% of their hit points to upgrade two random cards. Most floors demand much more: [the Duplicator event](https://slay-the-spire.fandom.com/wiki/Duplicator), any [rest site](https://slay-the-spire.fandom.com/wiki/Rest_Site) (without fusion hammer), any [Merchant event](https://slay-the-spire.fandom.com/wiki/Merchant) (when you have sufficient gold) offers you at least as many choices as there are cards in your deck. These just reflect decisions in the deck building portion of the game: there is as much or more complexity within each combat. 

In combat, one must select a card or potion (from a hand of up to 10 cards, a potion belt of up to 4 potions) and a target (of up to 5 enemies). This neglects cards like [Exhume](https://slay-the-spire.fandom.com/wiki/Exhume), [Headbutt](https://slay-the-spire.fandom.com/wiki/Headbutt), [Seek](https://slay-the-spire.fandom.com/wiki/Seek), [Hologram](https://slay-the-spire.fandom.com/wiki/Hologram), and any of the various [discard effects](https://slay-the-spire.fandom.com/wiki/Discard) and  [scry effects](https://slay-the-spire.fandom.com/wiki/Scry) all of which feature cascading decisions from playing a single card. It is popular, in the community, to point out that in this sense, the game is much more complex than chess or go. I've heard it claimed that even just the Jaw Worm fight with the starting deck is more complex than chess. 

In this short essay, I want to clarify the complexity discussion somewhat. Jaw Worm is much simpler than chess, for example, and I'll describe that in detail in [the following section](#jaw-worm-a-case-study). I'll then discuss [what complexity means](#complexity-in-games) in this context, and the practicality of [reinforcement learning solutions](#slAI-and-reinforcement-learning) for *Slay the Spire*. 

# Jaw worm: a case study
For the sake of simplicity, let's count the number of possible board configurations of the Ironclad starting deck, without a [blessing from Neow](https://slay-the-spire.fandom.com/wiki/Neow), in the fight with [Jaw Worm](https://slay-the-spire.fandom.com/wiki/Jaw_Worm). Jaw Worm can have 46 different amounts of HP, and the player can have 68 different amounts. Jaw Worm choses among three possible actions, with an AI depended on its previous three actions, meaning the AI is fully described by $3^3 = 27$ possibilities. The Ironclad start-of-turn deck can only be configured in a three different ways:
 1. On turn 1, and on turn 3 if Ascender's Bane is the bottommost card of the initial shuffle, there are five cards in hand and six cards in the draw pile.
 2. On turn 2, and on turn 4 if Ascender's Bane is the bottommost card of the initial shuffle, there are five cards in hand, one card in the draw pile, and either five or four cards in the discard pile
 3. On all other turns, there are five cards in hand, and four cards in the draw pile. 
Let's explicitly calculate how many options there are in the second case, which is the largest of the three options. We divide based on what card remains in the draw pile. 
 - If Bash is in the draw pile, then there are two options: Ascender's Bane is in the hand or has been exhausted. If it is in hand, there are 5 possible configurations (between 0 and 4 strikes also in hand, the remainder are defends), if it has been exhausted there are 5 possible configurations (between 1 and 5 strikes in hand). Thus, there are a total of 10 configurations.
 - If Ascender's Bane is in the draw pile, the case is completely symmetric with Bash, leading to 10 configurations.
 - If a Strike is in the draw pile, Bash can be either in hand or discarded, and Ascender's Bane can be either in hand or exhausted. If both are in hand, there are 4 possible configurations (the remaining contains between 0 and 3 strikes). If only one is in hand, there are 5 possible configurations, and if neither is in hand, there are likewise 5 possible configurations (0 - 4 strikes in hand, in either case). This means there are $4+2\times 5 + 5 = 19$ possible configurations. 
 - If a Defend is in the draw pile, then the Strike analysis carries over almost identically. The only difference is that there is one additional possibility, of the hand consisting of 5 Strikes, and three fewer possibilities, that there can no longer be four Defends in hand. Thus, there are 17 possibile configurations. 

Additionally, Jaw Worm can be vulnerable, for simplicity let's say they can have at most 20 stacks of vulnerable (just playing Bash the requisite 19 consecutive times should kill Jaw Worm). Jaw Worm can also have strength. For simplicity, we'll say there are 20 different levels of strength Jaw Worm can have (multiples of 5 between 0 and 95, at which point Jaw Worm must have already killed the player). Then we can pretty fairly approximate the number of possible Jaw Worm fight configurations against the Ironclad starting deck as
$$46 \times 68 \times 27 \times 56^3 \times 21 \times 20 \approx 6 \times 10^12. $$
For comparison, the best known upper bound on number of board configurations for chess is $\approx 7 \times 10^45$, according to [work by John Tromp](https://math.stackexchange.com/questions/1406919/how-many-legal-states-of-chess-exists). I don't think including Neow bonuses is going to make up the factor of $10^33$, but I'll leave the calculation of how Neow bonuses change the numbers to someone else. Certainly adding a random rare card and a random curse will greatly magnify the number of states, for example. 

By the numbers, we can certainly see that the Jaw Worm fight alone features a large number of board states, each of which we must be able to interact with, and *Slay the Spire* as a whole will quickly dwarf the number of possible board states featured by chess, Go, or any other classic board game. However, this doesn't make intuitive sense: Jaw Worm certainly feels like a much simpler task than playing chess, even with Neow's blessing and cards added to the deck! 

One point that is worth making is that, regardless of the number of states, there are only really 6 possible ways to play each turn: Bash + Strike, Bash + Defend, and playing between 0 and 3 strikes, with the remaining cards played being defends. Charitably, one could add a 7th possible way to play, in which one plays Strike before playing Bash. It is, at this point in the game, never reasonable to End Turn without using all of your available energy. Order of play starts to matter more as time goes on, but it never reaches the subtlety that play order has in chess, for instance. So what do we really mean by complexity? 

# Complexity in games
We've zeroed in on ``what are the number of possible board states," or similarly ``what are the number of possible actions" as candidates for the complexity of a game. From a reinforcement learning perspective, this makes a lot of sense! Classical, non-approximate methods for Reinforcement Learning require memory and computation directly in proportion to the number of states and the connectivity of the state-action system. (I will only briefly summarize classical RL methods; the standard reference book for the topic is Sutton and Barto's book, which is available freely online [here](http://incompleteideas.net/book/the-book-2nd.html).) In these methods, each possible state is assigned a value (e.g. What is the probability that, with optimal play, we defeat the Heart from this position.) The state-action system is then explored, and value estimates are updated based on what is observed. It is then relatively simple to prove that, under certain hypotheses and with reasonable update systems, we can learn true value estimates for each state. Once true values are known, optimal play can be made by simply choosing the action which leads to the states with the best values. Similar systems learn values associated to both states and actions, rather than just assigning them to states.

Modern reinforcement learning doesn't attempt to directly memorize values for every possible state, but instead attempts to learn a function from the board state to values. As long as the function system is simpler than the set of all possible board states, this allows you to work much more rapidly, and uses a finite amount of computer memory, which is important. We pay for these with the loss of some precision in our value estimates. 

## Case study: games with infinitely many states
However, this doesn't mean that the number of game states, or the number of possible actions, is a great metric for comparing how complex two different games are. Consider, for instance, what I'll call the Second Fiddle game: each player chooses a real number, and the person who chose the second highest real number wins. Obviously there are uncountably many possible actions, but that doesn't mean this game is more complex than chess, which after all only has a finite number of possible moves. It is easy to modify this game to have uncountable many board states, rather than just uncountably many actions. (For instance, each player after the first is told what number the preceding player chose, rather than choosing simultaneously.) 

If we don't want to admit defeat and say that it's impossible to design games more complex than "choose the second biggest number" (or perhaps, "choose the second biggest ordinal"), then our notion of complexity must be finer grained than simply counting board states and possible actions. At the same time, we must acknowledge that games with more states really are, quite often, more complex.

## Condition numbers
Ascension 1 of Slay the Spire is approximately as complex as Ascension 20. There are technically more states that appear in Ascension 20, due to the second Act 3 Boss, but Ascension 1 faces more decisions in Shops, due to the decreased price of Merchants. However, it is without question that Ascension 20 is substantially more difficult than Ascension 1. So what's the relationship between complexity and difficulty? 

I believe this is formally studied, and I'm not at all qualified to give a truly serious answer to the question. However, I think that one very important feature, in combination with the number of possible states, is the [condition number](https://en.wikipedia.org/wiki/Condition_number) of the problem. Roughly speaking, the condition number measures how sensitive a function is to small changes in its inputs. As we mentioned above, a key feature of modern reinforcement learning is the approximation of a value function. If it is easy to approximate the value function (typically by a neural net in computers), the problem is less difficult. From the human perspective, this is why something like fighting Jaw Worm seems simpler than playing a chess endgame, even though they have a comparable number of states. Many different shuffles are functionally very similar; a Jaw Worm with 41 hitpoints is very similar to, but slightly better than, a Jaw Worm with 42 hitpoints. Playing Strike and then Defend is very similar to playing Defend and then playing Strike. Compared to the subtleties of a Knight-and-Pawn end game, it simply isn't as hard to approximate how strong your position is. Within *Slay the Spire*, it is also the difference between Ascension 1 and Ascension 20: the value function is much smoother, simply because the enemies are weaker. 

# slAI and reinforcement learning
So is *Slay the Spire* a harder problem for reinforcement learning than Chess is? I'm genuinely unsure. Certainly building a chess simulator is much easier than building a *Slay the Spire* simulator. *Slay the Spire* also has very heterogeneous decisions, and multiple interlocking components will be needed to make decisions in combat, choose cards to add, and choose routes on the map. The human side of this, as a coding problem, is substantially more difficult than the human component of a simple chess engine. (Much research and time has gone into optimizing chess engines, including around problems like how to use their clock time as a meta-problem the AI must solve, and by no means do I want to imply this is not complex or serious work. Just that making the overall framework is simpler than the corresponding task for *Slay the Spire*.) 

However, I'm unconvinced that the training of a *Slay the Spire* engine is a harder problem than that of chess. I don't believe that the neural nets need to be substantially more complex, or that the computations need to be more deep, than what reinforcement learning agents are currently capable of. Ultimately, the question of whether *Slay the Spire* can be played by current reinforcement agents depends on the true value function for the system: is it well behaved? Can it be well approximated by a (neural) architecture? And what is its condition number?
